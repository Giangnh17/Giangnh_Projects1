<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt S√°ch - Trang web Qu·∫£n l√Ω th∆∞ vi·ªán s√°ch Sarly</title>
    
    <!-- CSS ri√™ng cho trang chi ti·∫øt s√°ch -->
    <link rel="stylesheet" href="/src/main/resources/static/css/book-detail.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>S</text></svg>">
    
    <!-- Th·∫ª meta -->
    <meta name="description" content="Xem chi ti·∫øt s√°ch trong th∆∞ vi·ªán">
    <meta name="keywords" content="th∆∞ vi·ªán, s√°ch, chi ti·∫øt, th√¥ng tin">
</head>
<body>
    <div class="page-wrapper">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="container">
                <div class="navbar-content">
                    <!-- Th∆∞∆°ng hi·ªáu/Logo -->
                    <a href="/src/main/resources/templates/index.html" class="navbar-brand">
                        Trang web Qu·∫£n l√Ω th∆∞ vi·ªán s√°ch Sarly
                    </a>
                    
                    <!-- User Information -->
                    <div class="navbar-nav">
                        <div class="user-info">
                            <div class="user-avatar">
                                <span id="userInitial">U</span>
                            </div>
                            <div class="user-details">
                                <div class="user-name" id="userName">Ng∆∞·ªùi d√πng</div>
                                <div class="user-role" id="userRole">ƒêang t·∫£i...</div>
                            </div>
                        </div>
                        
                        <!-- Logout Button -->
                        <button onclick="logout()" class="btn btn-outline logout-btn">
                            <span>üö™</span>
                            <span>ƒêƒÉng xu·∫•t</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <!-- Dynamic content will be loaded by JavaScript -->
                    <li class="nav-item active">
                        <a href="#" class="nav-link">
                            <span class="nav-icon">üìö</span>
                            <span class="nav-text">ƒêang t·∫£i...</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content with-sidebar">
            <div class="container">
                <div class="book-detail-container">
                    <!-- Book Header Section -->
                    <div class="book-cover-section">
                        <!-- Book Cover Placeholder -->
                        <div class="book-cover">
                            
                        </div>
                        
                        <!-- Book Basic Info -->
                        <div class="book-info">
                            <h1 id="bookTitle" class="book-title">Loading...</h1>
                            <p id="bookAuthor" class="book-author">by Author Name</p>
                            
                            <!-- Status Badge -->
                            <div style="margin: var(--spacing-lg) 0;">
                                <span id="bookStatus" class="status-badge status-available">Available</span>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="action-group" style="margin-top: var(--spacing-lg);">
                                <button class="btn btn-edit librarian-only" onclick="editCurrentBook()" style="margin-right: var(--spacing-md);">
                                    Edit Book
                                </button>
                                <button class="btn btn-delete librarian-only" onclick="deleteCurrentBook()">
                                    Delete Book
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Information Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Book Information</h2>
                            <p class="card-subtitle">Complete details and specifications</p>
                        </div>
                        
                        <!-- Book Metadata Grid -->
                        <div class="book-meta">
                            <div class="meta-item">
                                <div class="meta-label">ISBN</div>
                                <div id="bookISBN" class="meta-value">Loading...</div>
                            </div>
                            
                            <div class="meta-item">
                                <div class="meta-label">Category</div>
                                <div id="bookCategory" class="meta-value">Loading...</div>
                            </div>
                            
                            <div class="meta-item">
                                <div class="meta-label">Publisher</div>
                                <div id="bookPublisher" class="meta-value">Loading...</div>
                            </div>
                            
                            <div class="meta-item">
                                <div class="meta-label">Current Status</div>
                                <div id="bookStatusText" class="meta-value">Available for borrowing</div>
                            </div>
                        </div>
                        
                        <!-- Book Description -->
                        <div style="margin-top: var(--spacing-xl);">
                            <h3 style="margin-bottom: var(--spacing-md);">M√¥ t·∫£</h3>
                            <p id="bookDescription" style="line-height: 1.8; color: var(--color-primary-text); font-size: 1.05rem;">
                                Loading book description...
                            </p>
                        </div>
                    </div>
                    
                    <!-- Borrowing History Section -->
                    <div class="card history-section">
                        <div class="card-header">
                            <h2 class="card-title">L·ªãch s·ª≠ M∆∞·ª£n s√°ch</h2>
                            <p class="card-subtitle">Track record of this book's circulation</p>
                        </div>
                        
                        <div class="table-container">
                            <table class="table history-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40%;">Borrower</th>
                                        <th style="width: 30%;">Date Borrowed</th>
                                        <th style="width: 30%;">Date Returned</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic content populated by JavaScript -->
                                    <tr>
                                        <td colspan="3" class="text-center" style="padding: 30px; color: var(--color-accent); font-style: italic;">
                                            ƒêang t·∫£i l·ªãch s·ª≠ m∆∞·ª£n s√°ch...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Additional Information -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">‚ÑπÔ∏è Additional Information</h2>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
                            <div>
                                <h4 style="color: var(--color-accent); margin-bottom: var(--spacing-sm);">Location</h4>
                                <p>Section A, Shelf 12, Row 3</p>
                            </div>
                            
                            <div>
                                <h4 style="color: var(--color-accent); margin-bottom: var(--spacing-sm);">Date Added</h4>
                                <p>January 15, 2024</p>
                            </div>
                            
                            <div>
                                <h4 style="color: var(--color-accent); margin-bottom: var(--spacing-sm);">Total Borrows</h4>
                                <p id="totalBorrows">0 times</p>
                            </div>
                            
                            <div>
                                <h4 style="color: var(--color-accent); margin-bottom: var(--spacing-sm);">‚≠ê Condition</h4>
                                <p>Excellent</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="text-align: center; margin-top: var(--spacing-xxl);">
                        <button id="backToListBtn" class="btn btn-lg" style="margin-right: var(--spacing-md);">
                            Quay l·∫°i B·ªô s∆∞u t·∫≠p
                        </button>
                        
                        <button class="btn btn-secondary btn-lg librarian-only" onclick="editCurrentBook()">
                            Edit This Book
                        </button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer style="background: var(--color-primary-btn); color: var(--color-background); text-align: center; padding: var(--spacing-xl) 0; margin-top: var(--spacing-xxl);">
            <div class="container">
                <p style="margin: 0; font-size: 0.9rem;">
                    &copy; 2024 The Grand Library Management System
                </p>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <!-- JavaScript Modules -->
    <script src="/src/main/resources/static/js/api-service.js"></script>
    <script src="/src/main/resources/static/js/data.js"></script>
    <script src="/src/main/resources/static/js/utils.js"></script>
    <script src="/src/main/resources/static/js/book-detail.js"></script>
    
    <!-- Page-specific JavaScript -->
    <script>
        let currentBookId = null;
        
        // Get book ID from URL and initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Extract book ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            currentBookId = parseInt(urlParams.get('id'));
            
            if (!currentBookId) {
                showNotification('No book ID provided. Redirecting to library...', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // Load book details
            loadBookDetails(currentBookId);
        });
        
        function loadBookDetails(bookId) {
            // Find book in mock data
            const book = BOOKS_DATA.find(b => b.id === bookId);
            
            if (!book) {
                showNotification('Book not found. Redirecting to library...', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // Update page title
            document.title = `${book.title} - The Grand Library`;
            
            // Populate book information
            document.getElementById('bookTitle').textContent = book.title;
            document.getElementById('bookAuthor').textContent = `by ${book.author}`;
            document.getElementById('bookISBN').textContent = book.isbn;
            document.getElementById('bookCategory').textContent = book.category;
            document.getElementById('bookPublisher').textContent = book.publisher;
            document.getElementById('bookDescription').textContent = book.description;
            
            // Update status badge
            const statusBadge = document.getElementById('bookStatus');
            const statusText = document.getElementById('bookStatusText');
            
            statusBadge.className = `status-badge status-${book.status}`;
            statusBadge.textContent = book.status.charAt(0).toUpperCase() + book.status.slice(1);
            
            // Update status description
            const statusDescriptions = {
                available: 'Available for borrowing',
                borrowed: 'Currently borrowed by a member',
                lost: 'Marked as lost or missing'
            };
            statusText.textContent = statusDescriptions[book.status] || 'Status unknown';
            
            // Update total borrows count
            document.getElementById('totalBorrows').textContent = `${book.borrowHistory.length} times`;
            
            // Render borrowing history
            renderBorrowingHistory(book.borrowHistory);
            
            // Apply role-based visibility
            applyRoleBasedVisibility();
        }
        
        function renderBorrowingHistory(history) {
            const historyBody = document.querySelector('.history-table tbody');
            historyBody.innerHTML = '';
            
            if (history.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="3" class="text-center" style="padding: 30px; color: var(--color-accent); font-style: italic;">
                        Cu·ªën s√°ch n√†y ch∆∞a bao gi·ªù ƒë∆∞·ª£c m∆∞·ª£n
                    </td>
                `;
                historyBody.appendChild(row);
                return;
            }
            
            history.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'fade-in';
                
                const returnedText = record.returned ? record.returned : 
                    '<span style="color: var(--color-borrowed); font-weight: 600;">Not returned</span>';
                
                row.innerHTML = `
                    <td><strong>${record.borrower}</strong></td>
                    <td>${record.date}</td>
                    <td>${returnedText}</td>
                `;
                
                historyBody.appendChild(row);
            });
        }
        
        function editCurrentBook() {
            if (CURRENT_ROLE !== 'LIBRARIAN') {
                showNotification('You do not have permission to edit books.', 'error');
                return;
            }
            
            window.location.href = `book-form.html?mode=edit&id=${currentBookId}`;
        }
        
        function deleteCurrentBook() {
            if (CURRENT_ROLE !== 'LIBRARIAN') {
                showNotification('You do not have permission to delete books.', 'error');
                return;
            }
            
            const book = BOOKS_DATA.find(b => b.id === currentBookId);
            if (!book) return;
            
            const confirmed = confirm(
                `Are you sure you want to permanently delete "${book.title}"?\\n\\n` +
                `This action cannot be undone. All borrowing history will be lost.`
            );
            
            if (confirmed) {
                // Remove from data
                const index = BOOKS_DATA.findIndex(b => b.id === currentBookId);
                if (index !== -1) {
                    BOOKS_DATA.splice(index, 1);
                }
                
                showNotification(`"${book.title}" has been permanently deleted.`, 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }
        
        // Back button functionality
        document.getElementById('backBtn').addEventListener('click', function() {
            window.location.href = 'index.html';
        });
        
        document.getElementById('backToListBtn').addEventListener('click', function() {
            window.location.href = 'index.html';
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Escape or B to go back
            if (event.key === 'Escape' || event.key.toLowerCase() === 'b') {
                window.location.href = 'index.html';
            }
            
            // E to edit (Librarian only)
            if (event.key.toLowerCase() === 'e' && CURRENT_ROLE === 'LIBRARIAN') {
                editCurrentBook();
            }
        });
        
        // Add entrance animation
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card');
            const bookCover = document.querySelector('.book-cover-section');
            
            // Animate book cover section first
            if (bookCover) {
                bookCover.style.opacity = '0';
                bookCover.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    bookCover.style.transition = 'all 0.6s ease-out';
                    bookCover.style.opacity = '1';
                    bookCover.style.transform = 'translateY(0)';
                }, 200);
            }
            
            // Animate cards with stagger effect
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 600 + (index * 200));
            });
        });
        
        // Print functionality
        function printBookDetails() {
            window.print();
        }
        
        // Add print button if needed (optional)
        document.addEventListener('DOMContentLoaded', function() {
            // You can add a print button here if required
            // const printBtn = document.createElement('button');
            // printBtn.className = 'btn btn-outline';
            // printBtn.innerHTML = 'Print Details';
            // printBtn.onclick = printBookDetails;
            // document.querySelector('.action-group').appendChild(printBtn);
        });
    </script>
</body>
</html>