<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Điều khiển - Trang web Quản lý thư viện sách Sarly</title>
    
    <!-- CSS riêng cho trang chủ -->
    <link rel="stylesheet" href="/src/main/resources/static/css/index.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>S</text></svg>">
    
    <!-- Thẻ meta -->
    <meta name="description" content="Bảng điều khiển Trang web Quản lý thư viện sách Sarly">
    <meta name="keywords" content="thư viện, sách, quản lý, bảng điều khiển">
</head>
<body>
    <div class="page-wrapper">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="container">
                <div class="navbar-content">
                    <!-- Thương hiệu/Logo -->
                    <a href="/src/main/resources/templates/index.html" class="navbar-brand">
                        Trang web Quản lý thư viện sách Sarly
                    </a>
                    
                    <!-- User Info and Actions -->
                    <div class="navbar-nav">
                        <!-- User Information -->
                        <div class="user-info">
                            <div class="user-avatar">
                                <span>U</span>
                            </div>
                            <div>
                                <div class="user-name">Đang tải...</div>
                                <div style="font-size: 0.8rem; color: rgba(245, 241, 230, 0.8);">Thành viên</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item active">
                        <a href="/src/main/resources/templates/index.html" class="nav-link">
                            <span class="nav-text">Màn hình chính</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/src/main/resources/templates/user-form.html" class="nav-link">
                            <span class="nav-text">Thêm người dùng</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/src/main/resources/templates/book-form.html" class="nav-link">
                            <span class="nav-text">Thêm sách mới</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showReports()">
                            <span class="nav-text">Báo cáo</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSettings()">
                            <span class="nav-text">Cài đặt</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content with-sidebar">
            <div class="container">
                <!-- Tiêu đề trang -->
                <div class="mb-xl">
                    <h1 style="font-size: 2rem; margin-bottom: var(--spacing-sm);">Bộ sưu tập Thư viện</h1>
                    <p style="color: var(--color-accent); font-size: 1rem; font-style: italic;">
                        Khám phá và quản lý kho tàng văn học hùng vĩ của chúng ta
                    </p>
                </div>
                
                <!-- Toolbar -->
                <div class="toolbar">
                    <!-- Left Side - Search & Filter -->
                    <div class="toolbar-left">
                        <div class="search-container">
                            <div class="search-icon">Tìm</div>
                            <input 
                                type="text" 
                                id="searchInput"
                                class="form-control search-input" 
                                placeholder="Tìm kiếm sách theo tiêu đề, tác giả, ISBN hoặc thể loại..."
                                aria-label="Tìm kiếm sách"
                            >
                        </div>
                        
                        <select id="statusFilter" class="form-control" style="width: 150px;">
                            <option value="all">Tất cả trạng thái</option>
                            <option value="available">Có sẵn</option>
                            <option value="borrowed">Đã mượn</option>
                            <option value="lost">Bị mất</option>
                        </select>
                    </div>
                    
                    <!-- Right Side - Actions -->
                    <div class="toolbar-right">
                        <!-- Nút thêm sách (Chỉ thủ thư viện) -->
                        <button id="addBookBtn" class="btn librarian-only">
                            Thêm sách mới
                        </button>
                    </div>
                </div>
                
                <!-- Books Table -->
                <div class="table-container">
                    <table class="table books-table">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Mã số</th>
                                <th style="width: 35%;">Tiêu đề</th>
                                <th style="width: 25%;">Tác giả</th>
                                <th style="width: 15%;">Thể loại</th>
                                <th style="width: 10%;">Trạng thái</th>
                                <th style="width: 15%;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Nội dung động sẽ được tải bởi JavaScript -->
                            <tr>
                                <td colspan="6" class="text-center" style="padding: 40px; color: var(--color-accent); font-style: italic;">
                                    Đang tải bộ sưu tập thư viện của bạn...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Trạng thái trống (Mặc định ẩn) -->
                <div class="empty-state hidden" style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 4rem; color: var(--color-accent); margin-bottom: 20px;">�</div>
                    <h3 style="margin-bottom: 10px;">Không tìm thấy sách</h3>
                    <p style="color: var(--color-accent); margin-bottom: 20px;">
                        Thư viện có vẻ trống hoặc tìm kiếm của bạn không khớp với cuốn sách nào.
                    </p>
                    <button class="btn librarian-only" onclick="document.getElementById('addBookBtn').click()">
                        Thêm cuốn sách đầu tiên
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Chân trang -->
        <footer style="background: var(--color-primary-btn); color: var(--color-background); text-align: center; padding: var(--spacing-xl) 0; margin-top: var(--spacing-xxl);">
            <div class="container">
                <p style="margin: 0; font-size: 0.9rem;">
                    &copy; 2024 Trang web Quản lý thư viện sách Sarly | 
                    Xây dựng sử dụng Spring Boot & Thymeleaf
                </p>
                <p style="margin: var(--spacing-sm) 0 0; font-size: 0.8rem; opacity: 0.8; font-style: italic;">
                    "Thư viện là vô cực dưới một mái nhà." — Gail Carson Levine
                </p>
            </div>
        </footer>
    </div>
    
    <!-- Scroll to Top Button -->
    <button id="scrollToTop" class="hidden" style="
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: var(--color-primary-btn);
        color: var(--color-background);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        box-shadow: var(--shadow-medium);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        z-index: 1000;
        transition: all 0.3s ease;
    " title="Scroll to top">
        ⬆️
    </button>
    
    <!-- JavaScript Modules -->
    <script src="/src/main/resources/static/js/utils.js"></script>
    <script src="/src/main/resources/static/js/api-service.js"></script>
    <script src="/src/main/resources/static/js/auth.js"></script>
    <script src="/src/main/resources/static/js/book-management.js"></script>
    <script src="/src/main/resources/static/js/dashboard.js"></script>
    
    <!-- Page-specific JavaScript -->
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            if (!apiService.isAuthenticated()) {
                window.location.href = '/src/main/resources/templates/auth-login.html';
                return;
            }
            
            // Initialize book management
            initializeBookManagement();
            
            // Load user profile and setup navbar
            loadUserProfile();
            
            // Scroll to top functionality
            const scrollButton = document.getElementById('scrollToTop');
            
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    scrollButton.classList.remove('hidden');
                } else {
                    scrollButton.classList.add('hidden');
                }
            });
            
            scrollButton.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        });
        
        // Load and display user profile
        async function loadUserProfile() {
            try {
                const profile = apiService.getUserProfile();
                if (profile) {
                    // Update navbar with user info
                    const userInfo = document.querySelector('.user-info');
                    if (userInfo) {
                        userInfo.innerHTML = `
                            <span class="user-name">${profile.fullName}</span>
                            <span class="user-role">${getRoleDisplayName(profile.role)}</span>
                            <button class="btn btn-outline btn-sm" onclick="logout()">Đăng xuất</button>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }
        
        // Get display name for user role
        function getRoleDisplayName(role) {
            const roleMap = {
                'ROLE_USER': 'Thành viên',
                'ROLE_LIBRARIAN': 'Thủ thư',
                'ROLE_ADMIN': 'Quản trị viên'
            };
            return roleMap[role] || 'Thành viên';
        }
        
        // Enhanced search with keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + K for search focus
            if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                event.preventDefault();
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }
            
            // Ctrl/Cmd + N for new book (Librarian/Admin only)
            if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                if (hasRole('LIBRARIAN') || hasRole('ADMIN')) {
                    event.preventDefault();
                    window.location.href = '/src/main/resources/templates/book-form.html';
                }
            }
        });
        
        // Add book button handler
        document.addEventListener('DOMContentLoaded', function() {
            const addBookBtn = document.getElementById('addBookBtn');
            if (addBookBtn) {
                addBookBtn.addEventListener('click', function() {
                    window.location.href = '/src/main/resources/templates/book-form.html';
                });
            }
        });
        
        // Auto-refresh data periodically
        let lastRefresh = Date.now();
        setInterval(async function() {
            if (document.visibilityState === 'visible' && Date.now() - lastRefresh > 300000) { // 5 minutes
                await loadBooks();
                lastRefresh = Date.now();
                
                // Show subtle refresh indicator
                const indicator = document.createElement('div');
                indicator.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    background: var(--color-accent);
                    color: var(--color-background);
                    padding: 8px 16px;
                    border-radius: 4px;
                    font-size: 0.8rem;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                indicator.textContent = 'Dữ liệu đã được cập nhật';
                document.body.appendChild(indicator);
                
                setTimeout(() => indicator.style.opacity = '1', 10);
                setTimeout(() => {
                    indicator.style.opacity = '0';
                    setTimeout(() => indicator.remove(), 300);
                }, 2000);
            }
        }, 60000); // Check every minute
    </script>
</body>
</html>